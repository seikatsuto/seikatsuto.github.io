<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>YouTube 学習プレイヤー</title>
<style>
body { margin:0; background:#000; }
#player { width:100vw; height:100vh; }
</style>
</head>

<body data-grade="3" data-subject="算数">

<div id="player"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
/* ===== 基本情報 ===== */
const params   = new URLSearchParams(location.search);
const videoId  = params.get("v");
const pageId   = location.pathname + location.search;
const grade    = document.body.dataset.grade;
const subject  = document.body.dataset.subject;

/* ===== 時刻管理 ===== */
const enterTime = new Date().toISOString();
let playStart   = null;
let playSeconds = 0;

/* ===== YouTube Player ===== */
let player;

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: videoId,
    playerVars: {
      rel: 0,
      modestbranding: 1
    },
    events: {
      onStateChange: onPlayerStateChange
    }
  });
}

/* ===== 再生時間の正確計測 ===== */
function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    playStart = Date.now();
  }

  if (
    event.data === YT.PlayerState.PAUSED ||
    event.data === YT.PlayerState.ENDED
  ) {
    if (playStart) {
      playSeconds += Math.floor((Date.now() - playStart) / 1000);
      playStart = null;
    }
  }
}

/* ===== ログ保存 ===== */
function saveLog(exitTime) {
  if (playStart) {
    playSeconds += Math.floor((Date.now() - playStart) / 1000);
  }

  const logs = JSON.parse(localStorage.getItem("studyLog") || "[]");

  logs.push({
    date: new Date().toISOString().slice(0,10),
    grade: grade,
    subject: subject,
    page: pageId,
    videoId: videoId,
    enter: enterTime,
    exit: exitTime,
    playSeconds: playSeconds
  });

  localStorage.setItem("studyLog", JSON.stringify(logs));
}

/* ===== 退室検知 ===== */
window.addEventListener("beforeunload", () => {
  saveLog(new Date().toISOString());
});
</script>

</body>
</html>
