<!DOCTYPE html>
<html lang="ja">
<!-- ★ https://seikatsuto.github.io/testcon7/index4.html?score=1001****  前4桁順番 後４桁乱数 -->


<head>
  <meta charset="UTF-8">
  <title>学習スタート</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>

  </style>
</head>

<body>
<!-- 家族選択    zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz -->
<div id="out"></div>
  
<!-- <button onclick="loadCSV()">読み</button>  -->
<!-- <button onclick="main()">main1610</button>  -->
  
<script>
const params = new URLSearchParams(location.search);
const score = params.get("score");
let ninzu = 0+0;
let hito = "";
let futa = "";
let sann = "";
let yoni = "";
let come = "";
    
// 各家族ファイル読み込み zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz    
async function loadCSV() {
  // 機器IDを読む
  const logs = JSON.parse(localStorage.getItem("studyLogs") || "[]");
  const last = logs.at(-1) || {};
  let id = localStorage.getItem("deviceId");
  document.getElementById("out").textContent = "score=" + score+" id="+id;
  //alert("deviceId="+deviceId);

  const res = await fetch("data2.csv"); // ←ここで待つ
  const text = await res.text();        // ←ここで待つ
  const lines = text.trim().split("\n");

  // score が正しければこれを使用
  lines.forEach(line => {
      //const [a, b, c] = line.split(",");
      const [a, b, c, d, e, f, g, h] = line.split(",").map(v => v.trim());
      if((String(score) != String(a)) && (id != b))return;  //★score が正しくなければ機器IDを使用
      console.log("a =", a);
      console.log("b =", b);
      console.log("c =", c);
      console.log("d =", d);
      console.log("e =", e);
      //alert("a="+a+"  B="+b+"  c="+c);

      //document.getElementById("out").textContent = "score=" + score+" a="+a+"  b="+b+"  c="+c+" id="+id+" e="+e+" f="+f;
      ninzu = parseInt(c, 10)+0;  //
      //ninzu = c+0;  //
      hito = d;
      futa = e;
      sann = f;
      yoni = g;
      come = h;
      return;
  });
    // score 機器ID共に不適合
    //if((ninzu <=0) ||  (ninzu >=5))  {throw new Error("登録されていません");}//★
}
async function main() {
  await loadCSV();      // ← 終わるまで待つ
  //loadCSV();//★
  // score 機器ID共に不適合
  document.getElementById("out").textContent = "ninzu=" + String(ninzu)+" ninzu=" + ninzu+' hito='+hito;
  //document.getElementById("out").textContent = "ninzu=" + ninzu +' hito='+hito;
    
  //if((ninzu <=0) ||  (ninzu >=5))  {location.href = "next.html"; }   //★  throw new Error("登録されていません");
  if((hito ==='') && (futa ==='') && (sann ==='') && (yoni ==='')) {location.href = "next.html";    //★  throw new Error("登録されていません");
  }else{console.log(ninzu); console.log(hito);  // ← ここでOK
       localStorage.setItem("ninzu",ninzu );  //HTML変数引継ぎ方法
       localStorage.setItem("hito",hito );  //HTML変数引継ぎ方法
       localStorage.setItem("futa",futa );  //HTML変数引継ぎ方法
       localStorage.setItem("sann",sann );  //HTML変数引継ぎ方法
       localStorage.setItem("yoni",yoni );  //HTML変数引継ぎ方法
       localStorage.setItem("come",come );  //HTML変数引継ぎ方法
       location.href = "index444.html"; 
   }   //★
}
await main();     //★


</script>


<!-- zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz -->
</body>
</html>
