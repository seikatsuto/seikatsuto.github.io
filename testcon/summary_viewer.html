<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>視聴時間 集計表</title>
<style>
  body { font-family: sans-serif; }
  table { border-collapse: collapse; margin-top: 16px; width: 100%; }
  th, td { border: 1px solid #999; padding: 4px 6px; }
  th { background: #eee; }
  td { text-align: right; }
  td:first-child, th:first-child { text-align: center; }
  td:nth-child(2), td:nth-child(3) { text-align: left; }
</style>
</head>
<body>

<h2>視聴時間 集計表  ２０２６０１１０　１６００</h2>  <!--★★-->

<button onclick="makeSummary()">集計して表示</button>
<button onclick="exportSummary()">summary.csv 出力</button>

<div id="result"></div>

<script>
/* ==============================
   人定義（Python互換）
   ============================== */
const persons = [
  ["P1", "惟人君"],
  ["P2", "惺太郎君"],
  ["P3", "日花里君"],
  ["P4", "啓人君"]
];

const nameToIndex = {};
persons.forEach((p, i) => nameToIndex[p[1]] = i);

/* ==============================
   動画リスト（そのままコピペ）
   ============================== */
const VIDEO_LIST_HTML = `
<li><a href="player.html?v=LbYijVgaqhs">小1算数「時計のよみかた」</a></li>
<li><a href="player.html?v=m5zWD0b6Qtk">小1算数「くり上がりのたしざん」</a></li>
<li><a href="player.html?v=EeMsKOu7gSM">【はじめてのたしざん】ポケモンと一緒に目指せたし算マスター！幼児向け 子供向け 足し算の教え方</a></li>
<li><a href="player.html?v=mNnF8VEs7Pw">【はじめてのたしざん】かんたん!　すみっコぐらしのなかまたちと足し算をやってみよう！算数</a></li>
<li><a href="player.html?v=gwIiiUVNBIw">【小1算数学び方は１つじゃない！】繰り上がりの足し算「大事なこと２つ！」</a></li>
<li><a href="player.html?v=i5ZYm2ifikA">【小1の算数勉強法】1年生算数はここからスタートしたってください</a></li>
<li><a href="player.html?v=t3EtdTSuySY">【危険】指で数える計算を最短最速でやめる方法【低学年の計算力】</a></li>
<li><a href="player.html?v=t-d299r1D90">【学びの困り解決－小1算数】繰り下がりの引き算「補数の覚え方」~子ども達の多様な特性に工夫を！特別支援教育・発達障害・不登校・HSP・グレーゾーン~</a></li>
<li><a href="player.html?v=cvxUeY5ObCo">【はじめてのひきざん】ポケモンと一緒に目指せひき算マスター！幼児向け 子供向け 引き算の教え方</a></li>
<li><a href="player.html?v=5VG79qyabHw">小１算数_たしざん①</a></li>
<li><a href="player.html?v=3LqDdwPvsbc">【小１算数】　いくつといくつ②　動画を見るだけでも計算力ＵＰ！</a></li>
<li><a href="player.html?v=xCPYMJ3zubI">【算数】よく分かる！さくらんぼ計算【たしざん】</a></li>
`;

/* ==============================
   動画リスト解析
   ============================== */
const parser = new DOMParser();
const doc = parser.parseFromString(`<ul>${VIDEO_LIST_HTML}</ul>`, "text/html");

const videoList = [...doc.querySelectorAll("a")].map((a, i) => {
  const url = new URL(a.href, location.href);
  const title = a.textContent.trim();
  return {
    no: i + 1,
    videoId: url.searchParams.get("v"),
    title: title,
    shortTitle: title.slice(0, 15)
  };
});

const videoIndex = {};
videoList.forEach((v, i) => videoIndex[v.videoId] = i);

/* 集計結果 */
let watch = [];

/* ==============================
   集計処理
   ============================== */
function makeSummary() {
  const logs = JSON.parse(localStorage.getItem("studyLogs") || "[]");

  watch = Array.from(
    { length: videoList.length },
    () => Array(persons.length).fill(0)
  );

  logs.forEach(l => {
    const name = l.child;
    const vid  = l.video;
    if (!(name in nameToIndex)) return;
    if (!(vid in videoIndex)) return;

    //const min = Math.round(l.duration / 60000);  //★★
    const min = Math.round(l.duration);  //★★  
    watch[videoIndex[vid]][nameToIndex[name]] += min;
  });

  renderTable();
}

/* ==============================
   表表示（全ゼロ行除外）
   ============================== */
function renderTable() {
  const div = document.getElementById("result");
  div.innerHTML = "";

  const table = document.createElement("table");

  const trh = document.createElement("tr");
  trh.innerHTML =
    "<th>No</th><th>VideoID</th><th>タイトル</th>" +
    persons.map(p => `<th>${p[1]}</th>`).join("");
  table.appendChild(trh);

  watch.forEach((row, i) => {
    if (row.every(v => v === 0)) return;// ★ 全ゼロ行を除外

    const v = videoList[i];
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td>${v.no}</td>` +
      `<td>${v.videoId}</td>` +
      `<td title="${v.title}">${v.shortTitle}</td>` +
      row.map(v => `<td>${v}</td>`).join("");

    table.appendChild(tr);
  });

  div.appendChild(table);
}

/* ==============================
   CSV 出力
   ============================== */
function exportSummary() {
  if (watch.length === 0) {
    alert("先に集計してください");
    return;
  }

  let csv = "\uFEFF";
  csv += ["No", "VideoID", "Title", ...persons.map(p => p[1])].join(",") + "\n";

  watch.forEach((row, i) => {
    const v = videoList[i];
    csv += [v.no, v.videoId, v.title, ...row].join(",") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "summary.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
